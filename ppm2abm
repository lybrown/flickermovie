#!/usr/bin/perl
use strict;
use warnings;
my %pal;

## grey
#$pal{"0,0,0"} = [0, 0];
#$pal{"50,50,50"} = [0, 1];
#$pal{"85,85,85"} = [0, 2];
#$pal{"119,119,119"} = [0, 3];
## red
#$pal{"38,7,14"} = [1, 0];
#$pal{"110,48,63"} = [1, 1];
#$pal{"144,82,97"} = [1, 2];
#$pal{"165,116,131"} = [1, 3];
## green
#$pal{"15,31,0"} = [3, 0];
#$pal{"68,83,13"} = [3, 1];
#$pal{"102,117,47"} = [3, 2];
#$pal{"136,151,81"} = [3, 3];
## blue
#$pal{"10,14,79"} = [2, 0];
#$pal{"51,63,137"} = [2, 1];
#$pal{"85,97,171"} = [2, 2];
#$pal{"119,131,179"} = [2, 3];

# grey
$pal{"0,0,0"} = [0, 0];
$pal{"51,51,51"} = [0, 1];
$pal{"85,85,85"} = [0, 2];
$pal{"119,119,119"} = [0, 3];
# red
$pal{"59,0,18"} = [1, 0];
$pal{"110,51,69"} = [1, 1];
$pal{"144,85,103"} = [1, 2];
$pal{"178,119,137"} = [1, 3];
# green
$pal{"18,31,0"} = [3, 0];
$pal{"69,82,51"} = [3, 1];
$pal{"103,116,85"} = [3, 2];
$pal{"137,150,119"} = [3, 3];
# blue
$pal{"0,13,85"} = [2, 0];
$pal{"51,64,136"} = [2, 1];
$pal{"85,98,170"} = [2, 2];
$pal{"119,132,204"} = [2, 3];

sub bitmap {
  my ($frame) = @_;
  open my $fh, $frame or die "ERROR: Cannot open $frame: $!\n";
  scalar <$fh> for 0,1,2;
  my $data = join "", <$fh>;
  my @pixels;
  push @pixels, $pal{"$1,$2,$3"} || [0,0] while $data =~ m/(\d+) (\d+) (\d+)/g;
  my $line = 0;
  $frame =~ /(\d+)/;
  my $i = ($1 || 0) & 1 ? 1 : 0;
  while (@pixels) {
    print chr(0) x 16 if $line++ == 204;
    my @line = splice @pixels, 0, 160;
    for (my $x = 0; $x < 160; $x += 4) {
      my $byte = $line[$x+0][$i] << 6 | $line[$x+1][$i] << 4 | $line[$x+2][$i] << 2 | $line[$x+3][$i];
      print chr $byte;
    }
    $i = 1 - $i;
  }
}
bitmap($ARGV[0]);

